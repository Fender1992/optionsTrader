{% extends "base.html" %}

{% block title %}Dashboard - Options Trading{% endblock %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<div class="grid">
    <div class="card">
        <h2>Account Overview</h2>
        <table>
            <tr>
                <td>Total Equity</td>
                <td><strong>${{ "{:,.2f}".format(account_info.get('total_equity', 0)) }}</strong></td>
            </tr>
            <tr>
                <td>Cash Available</td>
                <td>${{ "{:,.2f}".format(account_info.get('cash', 0)) }}</td>
            </tr>
            <tr>
                <td>Positions</td>
                <td>{{ positions|length }}</td>
            </tr>
            <tr>
                <td>Initial Capital</td>
                <td>${{ "{:,.2f}".format(initial_capital) }}</td>
            </tr>
            <tr>
                <td>Current Return</td>
                <td class="{% if account_info.get('total_equity', 0) >= initial_capital %}text-success{% else %}text-danger{% endif %}">
                    {{ "{:.1%}".format((account_info.get('total_equity', initial_capital) - initial_capital) / initial_capital if initial_capital > 0 else 0) }}
                </td>
            </tr>
        </table>
    </div>
    
    <div class="card">
        <h2>System Controls</h2>
        <table>
            <tr>
                <td>Kill Switch</td>
                <td>
                    <label class="toggle-switch">
                        <input type="checkbox" id="kill-switch" {% if kill_switch == 'true' %}checked{% endif %} onchange="toggleKillSwitch()">
                        <span class="slider"></span>
                    </label>
                    <span id="kill-status" class="status-badge {% if kill_switch == 'true' %}status-inactive{% else %}status-active{% endif %}">
                        {% if kill_switch == 'true' %}BLOCKED{% else %}ACTIVE{% endif %}
                    </span>
                </td>
            </tr>
            <tr>
                <td>Trading Mode</td>
                <td>
                    <span class="status-badge {% if execution_mode == 'live' %}status-active{% else %}status-inactive{% endif %}">
                        {{ execution_mode|upper }}
                    </span>
                    <button onclick="toggleMode()" class="btn btn-{% if execution_mode == 'live' %}danger{% else %}success{% endif %}" style="padding: 0.25rem 0.75rem; margin-left: 0.5rem;">
                        Switch to {% if execution_mode == 'paper' %}LIVE{% else %}PAPER{% endif %}
                    </button>
                </td>
            </tr>
            <tr>
                <td>Last Update</td>
                <td>{{ last_update }}</td>
            </tr>
        </table>
    </div>
</div>

<div class="card">
    <h2>Equity Milestones</h2>
    <table>
        <tr>
            <td>Baseline</td>
            <td>${{ "{:,.2f}".format(milestone_info.get('baseline', 0)) }}</td>
        </tr>
        <tr>
            <td>Highest Equity</td>
            <td>${{ "{:,.2f}".format(milestone_info.get('highest_equity', 0)) }}</td>
        </tr>
        <tr>
            <td>Last Milestone</td>
            <td>
                {% if milestone_info.get('last_milestone_multiplier', 1) > 1 %}
                    <span class="status-badge status-active">{{ milestone_info.get('last_milestone_multiplier') }}×</span>
                {% else %}
                    <span class="status-badge">None</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td>Next Target</td>
            <td>
                <strong>${{ "{:,.2f}".format(milestone_info.get('next_target', 0)) }}</strong>
                <span style="color: #666;">({{ milestone_info.get('next_multiplier', 2) }}×)</span>
            </td>
        </tr>
        <tr>
            <td>Progress to Next</td>
            <td>
                {% set progress = ((account_info.get('total_equity', 0) - milestone_info.get('baseline', 1)) / (milestone_info.get('next_target', 1) - milestone_info.get('baseline', 1)) * 100) if milestone_info.get('next_target', 0) > milestone_info.get('baseline', 0) else 0 %}
                <div style="background: #e0e0e0; border-radius: 4px; height: 20px; position: relative;">
                    <div style="background: #1a73e8; border-radius: 4px; height: 100%; width: {{ [progress, 100]|min }}%;"></div>
                </div>
                <small>{{ "{:.1f}".format([progress, 100]|min) }}%</small>
            </td>
        </tr>
    </table>
    <div style="margin-top: 1rem;">
        <button onclick="testNotification()" class="btn" style="margin-right: 0.5rem;">Test Alert</button>
        <button onclick="resetBaseline()" class="btn btn-warning">Reset Baseline</button>
    </div>
</div>

<div class="card">
    <h2>Portfolio Equity</h2>
    <div id="equity-chart"></div>
</div>

<div id="notification-badge" style="position: fixed; top: 1rem; right: 1rem; background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 4px; display: none; z-index: 1000;">
    <span id="notification-text"></span>
</div>

<div class="card">
    <h2>Current Positions</h2>
    {% if positions %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Quantity</th>
                    <th>Cost Basis</th>
                    <th>Market Value</th>
                    <th>Unrealized P&L</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in positions %}
                <tr>
                    <td>{{ pos.symbol }}</td>
                    <td>{{ pos.quantity }}</td>
                    <td>${{ "{:,.2f}".format(pos.cost_basis) }}</td>
                    <td>${{ "{:,.2f}".format(pos.market_value) }}</td>
                    <td class="{% if pos.unrealized_pnl >= 0 %}text-success{% else %}text-danger{% endif %}">
                        ${{ "{:,.2f}".format(pos.unrealized_pnl) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No open positions</p>
    {% endif %}
</div>

<div class="card">
    <h2>Manual Actions</h2>
    <div class="grid">
        <button onclick="runJob('update_data')" class="btn">Update Data</button>
        <button onclick="runJob('build_features')" class="btn">Build Features</button>
        <button onclick="runJob('generate_signals')" class="btn">Generate Signals</button>
        <button onclick="runJob('execute_trades')" class="btn btn-success">Execute Trades</button>
        <button onclick="runJob('reconcile')" class="btn">Reconcile Positions</button>
        <button onclick="viewLogs()" class="btn">View Logs</button>
    </div>
</div>

<div class="card" id="logs-section" style="display: none;">
    <h2>Recent Logs</h2>
    <div id="logs-content" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;">
    </div>
</div>

<div style="text-align: center; padding: 2rem;">
    <a href="/logout" class="btn btn-danger">Logout</a>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    const equityData = {{ equity_chart|safe }};
    if (equityData) {
        Plotly.newPlot('equity-chart', equityData.data, equityData.layout);
    }
    
    async function toggleKillSwitch() {
        const response = await fetch('/api/toggle-kill-switch', {method: 'POST'});
        const data = await response.json();
        
        const status = document.getElementById('kill-status');
        if (data.kill_switch === 'true') {
            status.className = 'status-badge status-inactive';
            status.textContent = 'BLOCKED';
        } else {
            status.className = 'status-badge status-active';
            status.textContent = 'ACTIVE';
        }
    }
    
    async function toggleMode() {
        if (confirm('Are you sure you want to change the trading mode?')) {
            const response = await fetch('/api/toggle-mode', {method: 'POST'});
            location.reload();
        }
    }
    
    async function updateCapital() {
        const capital = document.getElementById('capital-input').value;
        const response = await fetch('/api/set-capital', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({capital: parseFloat(capital)})
        });
        
        if (response.ok) {
            alert('Capital updated successfully');
        }
    }
    
    async function runJob(jobName) {
        if (confirm(`Run ${jobName} job?`)) {
            const response = await fetch('/api/run-job', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({job: jobName})
            });
            
            const data = await response.json();
            alert(data.status);
        }
    }
    
    async function viewLogs() {
        const section = document.getElementById('logs-section');
        const content = document.getElementById('logs-content');
        
        const response = await fetch('/api/logs');
        const data = await response.json();
        
        content.innerHTML = data.logs.map(log => 
            `<div style="border-bottom: 1px solid #eee; padding: 0.5rem;">
                <strong>${log.timestamp}</strong> - ${log.action}<br>
                <pre>${JSON.stringify(log.details, null, 2)}</pre>
            </div>`
        ).join('');
        
        section.style.display = 'block';
    }
    
    async function testNotification() {
        const totp = prompt('Enter 2FA code (if enabled):');
        const response = await fetch('/api/alerts/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({totp_code: totp})
        });
        
        const data = await response.json();
        alert(data.message);
    }
    
    async function resetBaseline() {
        if (confirm('Reset equity baseline to current equity? This will restart milestone tracking.')) {
            const totp = prompt('Enter 2FA code (if enabled):');
            const response = await fetch('/api/alerts/equity-doubling/reset', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({totp_code: totp})
            });
            
            if (response.ok) {
                alert('Baseline reset successfully');
                location.reload();
            }
        }
    }
    
    async function checkNotifications() {
        const response = await fetch('/api/notifications');
        const data = await response.json();
        
        if (data.notifications && data.notifications.length > 0) {
            const badge = document.getElementById('notification-badge');
            const text = document.getElementById('notification-text');
            
            text.textContent = data.notifications[0].title;
            badge.style.display = 'block';
            
            // Mark as read after 5 seconds
            setTimeout(async () => {
                badge.style.display = 'none';
                await fetch('/api/notifications/mark-read', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ids: data.notifications.map(n => n.id)})
                });
            }, 5000);
        }
    }
    
    // Check for notifications every 30 seconds
    setInterval(checkNotifications, 30000);
    checkNotifications();
    
    setInterval(async () => {
        const response = await fetch('/api/positions');
        if (response.ok) {
            location.reload();
        }
    }, 60000);
</script>
{% endblock %}